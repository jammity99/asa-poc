
name: ASA Security Scan

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

jobs:
  asa-scan:
    runs-on: windows-latest

    steps:
      # 1) Checkout
      - name: Checkout
        uses: actions/checkout@v4

      # 2) Setup .NET (for ASA global tool)
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      # 3) Setup Python (so python is guaranteed)
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # 4) Install ASA CLI (use tool-path so we can reliably call `asa`)
      - name: Install ASA CLI
        shell: pwsh
        run: |
          $toolPath = Join-Path $env:RUNNER_TEMP "dotnet-tools"
          New-Item -ItemType Directory -Force -Path $toolPath | Out-Null
          dotnet tool install Microsoft.CST.AttackSurfaceAnalyzer.CLI --tool-path $toolPath
          $toolPath | Out-File -FilePath $env:GITHUB_PATH -Append
          asa --version

      # 5) Baseline snapshot (work from temp folder so ASA stores its state cleanly)
      - name: Baseline collect
        shell: pwsh
        run: |
          $asaWork = Join-Path $env:RUNNER_TEMP "asa-work"
          New-Item -ItemType Directory -Force -Path $asaWork | Out-Null
          Push-Location $asaWork
          asa collect -f -s -r -w -p --selected-directories "${{ github.workspace }}"
          Pop-Location

      # 6) Run your app script to create a diff
      - name: Execute app script
        shell: pwsh
        run: |
          if (Test-Path "${{ github.workspace }}\app\asset.py") {
            python "${{ github.workspace }}\app\asset.py"
          } else {
            Write-Host "[INFO] app\asset.py not found. Creating demo diff file."
            New-Item -ItemType Directory -Force -Path "${{ github.workspace }}\artifacts\demo" | Out-Null
            Set-Content -Path "${{ github.workspace }}\artifacts\demo\hello.txt" -Value "ASA should detect this file."
          }

      # 7) Product snapshot
      - name: Product collect
        shell: pwsh
        run: |
          $asaWork = Join-Path $env:RUNNER_TEMP "asa-work"
          Push-Location $asaWork
          asa collect -f -s -r -w -p --selected-directories "${{ github.workspace }}"
          Pop-Location

      # 8) Export SARIF (from the same ASA working folder)
      - name: Export SARIF
        shell: pwsh
        run: |
          $asaWork = Join-Path $env:RUNNER_TEMP "asa-work"
          Push-Location $asaWork
          asa export-collect --outputsarif
          if (-not (Test-Path ".\attack_surface_analyzer.sarif")) {
            throw "SARIF not generated. Check ASA export output above."
          }
          Copy-Item ".\attack_surface_analyzer.sarif" "${{ github.workspace }}\attack_surface_analyzer.sarif" -Force
          Pop-Location

      # 9) Upload SARIF to GitHub Security (Code Scanning)
      - name: Upload SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: attack_surface_analyzer.sarif

      # 10) Optional Gate: Fail on High severity (best-effort)
      - name: Fail on High Severity (gate)
        shell: pwsh
        run: |
          $sarifPath = "${{ github.workspace }}\attack_surface_analyzer.sarif"
          $sarif = Get-Content $sarifPath -Raw | ConvertFrom-Json

          # Best-effort severity detection: ASA may encode severity differently per rule.
          # We treat SARIF "error" level as high.
          $highCount = @($sarif.runs.results | Where-Object { $_.level -eq "error" }).Count

          if ($highCount -gt 0) {
            Write-Error "High severity findings detected (error-level): $highCount"
            exit 1
          } else {
            Write-Host "[OK] No error-level (high) findings."
          }

      # 11) Upload artifacts for later download
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: asa-outputs
          path: |
            attack_surface_analyzer.sarif
            artifacts/**
