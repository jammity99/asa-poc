
name: ASA Security Scan

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

jobs:
  asa-scan:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # 1) Install ASA CLI (Option A: call asa.exe directly)
      - name: Install ASA CLI
        shell: pwsh
        run: |
          $toolPath = Join-Path $env:RUNNER_TEMP "dotnet-tools"
          New-Item -ItemType Directory -Force -Path $toolPath | Out-Null

          dotnet tool install Microsoft.CST.AttackSurfaceAnalyzer.CLI --tool-path $toolPath

          "ASA_TOOLPATH=$toolPath" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8

          $asaExe = Join-Path $toolPath "asa.exe"
          if (-not (Test-Path $asaExe)) { throw "asa.exe not found: $asaExe" }

          & $asaExe --version
          Write-Host "[INFO] asa --version exit code: $LASTEXITCODE"
          exit 0

      # 2) Baseline snapshot (files in repo + system collectors like ports/registry/services)
      - name: Baseline collect (files + ports/registry/services)
        shell: pwsh
        run: |
          $asaExe  = Join-Path $env:ASA_TOOLPATH "asa.exe"
          $asaWork = Join-Path $env:RUNNER_TEMP "asa-work"
          New-Item -ItemType Directory -Force -Path $asaWork | Out-Null

          Push-Location $asaWork
          # File scope limited to the repo; system collectors (ports/registry/services) are machine-level.
          & $asaExe collect -f -r -s -p --directories "${{ github.workspace }}"
          Pop-Location

      # 3) Create a diff (your app script)
      - name: Execute app script
        shell: pwsh
        run: |
          if (Test-Path "${{ github.workspace }}\app\asset.py") {
            python "${{ github.workspace }}\app\asset.py"
          } else {
            Write-Host "[INFO] app\asset.py not found. Creating demo diff file."
            New-Item -ItemType Directory -Force -Path "${{ github.workspace }}\artifacts\demo" | Out-Null
            Set-Content -Path "${{ github.workspace }}\artifacts\demo\hello.txt" -Value "ASA should detect this file."
          }

      # 4) Product snapshot
      - name: Product collect (files + ports/registry/services)
        shell: pwsh
        run: |
          $asaExe  = Join-Path $env:ASA_TOOLPATH "asa.exe"
          $asaWork = Join-Path $env:RUNNER_TEMP "asa-work"

          Push-Location $asaWork
          & $asaExe collect -f -r -s -p --directories "${{ github.workspace }}"
          Pop-Location

      # 5) Export SARIF (auto-detect produced SARIF file and copy to stable name)
      - name: Export SARIF (normalize filename)
        shell: pwsh
        run: |
          $asaExe  = Join-Path $env:ASA_TOOLPATH "asa.exe"
          $asaWork = Join-Path $env:RUNNER_TEMP "asa-work"

          Push-Location $asaWork

          # Export SARIF using documented option. ASA compares the latest two runs if run IDs not provided. [1](https://www.microsoft.com/en-us/download/details.aspx?id=58105)
          & $asaExe export-collect --outputsarif --disableimplicitfindings

          # ASA writes a timestamped file like *_summary.Sarif (as in your log)
          $sarif = Get-ChildItem -File -Recurse |
                   Where-Object { $_.Name -match '\.sarif$|\.Sarif$' } |
                   Sort-Object LastWriteTime -Descending |
                   Select-Object -First 1

          if (-not $sarif) {
            Write-Host "=== Directory listing (asa-work) ==="
            Get-ChildItem -Recurse | Select-Object FullName
            throw "No SARIF file found in asa-work after export-collect."
          }

          Write-Host "[OK] Found SARIF: $($sarif.FullName)"
          Copy-Item $sarif.FullName "${{ github.workspace }}\attack_surface_analyzer.sarif" -Force

          Pop-Location

      # 6) Upload SARIF to GitHub Security (Code Scanning alerts)
      - name: Upload SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: attack_surface_analyzer.sarif

      # 7) Upload artifacts for download
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: asa-outputs
          path: |
            attack_surface_analyzer.sarif
            artifacts/**
