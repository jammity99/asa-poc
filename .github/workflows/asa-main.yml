
name: ASA Security Scan

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

jobs:
  asa-scan:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # --- Install ASA CLI (Option A) ---
      - name: Install ASA CLI
        shell: pwsh
        run: |
          $toolPath = Join-Path $env:RUNNER_TEMP "dotnet-tools"
          New-Item -ItemType Directory -Force -Path $toolPath | Out-Null

          dotnet tool install Microsoft.CST.AttackSurfaceAnalyzer.CLI --tool-path $toolPath

          # Persist tool path for next steps
          "ASA_TOOLPATH=$toolPath" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8

          $asaExe = Join-Path $toolPath "asa.exe"
          if (-not (Test-Path $asaExe)) {
            throw "asa.exe not found at expected path: $asaExe"
          }

          # Print version but DO NOT fail the step if ASA returns non-zero here
          & $asaExe --version
          Write-Host "[INFO] asa --version exit code was: $LASTEXITCODE"
          exit 0

      # --- Baseline snapshot (file system only) ---
      - name: Baseline collect (files only)
        shell: pwsh
        run: |
          $asaExe  = Join-Path $env:ASA_TOOLPATH "asa.exe"
          $asaWork = Join-Path $env:RUNNER_TEMP "asa-work"
          New-Item -ItemType Directory -Force -Path $asaWork | Out-Null

          Push-Location $asaWork
          # Documented pattern: collect -f and directories, then export-collect --outputsarif [1](https://github.com/microsoft/AttackSurfaceAnalyzer/wiki/CLI-Walkthrough)
          & $asaExe collect -f --directories "${{ github.workspace }}"
          Pop-Location

      # --- Make a diff (your app script) ---
      - name: Execute app script
        shell: pwsh
        run: |
          if (Test-Path "${{ github.workspace }}\app\asset.py") {
            python "${{ github.workspace }}\app\asset.py"
          } else {
            Write-Host "[INFO] app\asset.py not found. Creating demo diff file."
            New-Item -ItemType Directory -Force -Path "${{ github.workspace }}\artifacts\demo" | Out-Null
            Set-Content -Path "${{ github.workspace }}\artifacts\demo\hello.txt" -Value "ASA should detect this file."
          }

      # --- Product snapshot (file system only) ---
      - name: Product collect (files only)
        shell: pwsh
        run: |
          $asaExe  = Join-Path $env:ASA_TOOLPATH "asa.exe"
          $asaWork = Join-Path $env:RUNNER_TEMP "asa-work"

          Push-Location $asaWork
          & $asaExe collect -f --directories "${{ github.workspace }}"
          Pop-Location

      # --- Export SARIF ---
      - name: Export SARIF
        shell: pwsh
        run: |
          $asaExe  = Join-Path $env:ASA_TOOLPATH "asa.exe"
          $asaWork = Join-Path $env:RUNNER_TEMP "asa-work"

          Push-Location $asaWork
          # Export SARIF; optional flag disables implicit findings to reduce noise [1](https://github.com/microsoft/AttackSurfaceAnalyzer/wiki/CLI-Walkthrough)
          & $asaExe export-collect --outputsarif --disableimplicitfindings

          if (-not (Test-Path ".\attack_surface_analyzer.sarif")) {
            throw "SARIF not generated. Check ASA export output above."
          }

          Copy-Item ".\attack_surface_analyzer.sarif" "${{ github.workspace }}\attack_surface_analyzer.sarif" -Force
          Pop-Location

      # Upload SARIF to GitHub Code Scanning
      - name: Upload SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: attack_surface_analyzer.sarif

      # Upload artifacts
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: asa-outputs
          path: |
            attack_surface_analyzer.sarif
            artifacts/**
